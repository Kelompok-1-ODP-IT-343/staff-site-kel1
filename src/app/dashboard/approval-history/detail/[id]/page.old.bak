"use client";

import DetailPage from "@/app/dashboard/detail/[id]/page";

// Clean minimal wrapper. All previous legacy content removed.
export default function ApprovalHistoryDetailWrapper(props: any) {
  return <DetailPage {...props} />;
}

// Note: If Next.js warns about importing a page component, move DetailPage logic
// into a shared component (e.g. src/app/dashboard/components/ApplicationDetail.tsx)
// and import that instead in both routes.

          {/* Nasabah */}
          <SummaryCard
            colors={colors}
            icon={<User2 className="h-7 w-7" color={colors.blue} />}
            title="Nasabah"
          >
            <h3 className="font-semibold text-black text-xl">{customer.name}</h3>
            <div className="text-sm text-gray-600 space-y-0.5">
              <p>{customer.email}</p>
              <p>{customer.phone ?? '-'}</p>
            </div>
          </SummaryCard>

          {/* Plafon */}
          <SummaryCard
            colors={colors}
            icon={<Wallet className="h-7 w-7" color={colors.blue} />}
            title="Plafon"
          >
            <h3 className="font-semibold text-black text-2xl">
              Rp{Math.round((application?.loanAmount ?? loanAmount) as number).toLocaleString('id-ID')}
            </h3>
            <p className="text-sm text-gray-600">
              Tenor {(() => {
                const lt = Number(application?.loanTermYears);
                if (!lt || Number.isNaN(lt)) return tenor;
                return lt > 50 ? lt : lt * 12;
              })()} bulan
            </p>
          </SummaryCard>

          {/* FICO® Score */}
          <SummaryCard
            colors={colors}
            icon={<BarChart3 className="h-7 w-7" color={colors.blue} />}
            title="FICO® Score"
          >
            {scoreLoading ? (
              <div className="text-sm text-muted-foreground">Loading score...</div>
            ) : (
              <div className="relative w-40 h-20">
                <svg viewBox="0 0 100 50" className="w-full h-full">
                  <path d="M10 50 A40 40 0 0 1 90 50" fill="none" stroke="#E5E7EB" strokeWidth="8" strokeLinecap="round" />
                  <path
                    d="M10 50 A40 40 0 0 1 90 50"
                    fill="none"
                    stroke={
                      score <= 560 ? '#EF4444' :
                      score <= 650 ? '#F97316' :
                      score <= 700 ? '#EAB308' :
                      score <= 750 ? '#3B82F6' : '#22C55E'
                    }
                    strokeWidth="8"
                    strokeDasharray={`${((score - 300) / 550) * 126} 126`}
                    strokeLinecap="round"
                  />
                  <text x="50" y="32" textAnchor="middle" fontSize="14" fontWeight="800" fill="#111827">{score}</text>
                  <text
                    x="50"
                    y="44"
                    textAnchor="middle"
                    fontSize="7"
                    fontWeight="600"
                    fill={
                      score <= 560 ? '#dc2626' :
                      score <= 650 ? '#ea580c' :
                      score <= 700 ? '#ca8a04' :
                      score <= 750 ? '#2563eb' : '#16a34a'
                    }
                  >
                    {score <= 560 ? 'Very Bad'
                      : score <= 650 ? 'Bad'
                      : score <= 700 ? 'Fair'
                      : score <= 750 ? 'Good' : 'Excellent'}
                  </text>
                </svg>
              </div>
            )}
          </SummaryCard>
        </section>

        {/* Approval Progress + Actions - MOVED UP */}
        <section className="border rounded-2xl p-5 bg-white shadow-sm space-y-6" style={{ borderColor: colors.gray + '33' }}>
          <h2 className="font-semibold text-black text-lg mb-2 flex items-center gap-2">
            <Settings2 className="h-6 w-6 text-[#3FD8D4]" /> Approval Progress
          </h2>

          {/* Futuristic stepper */}
          <div className="relative px-2 py-4">
            <div className="absolute left-8 right-8 top-8 h-1 bg-gradient-to-r from-gray-200 via-[#3FD8D4]/40 to-gray-200 rounded-full" />
            <div className="grid grid-cols-4 gap-4 relative">
              {[0,1,2,3].map((i) => {
                const state = nodeState(i);
                const base = 'flex flex-col items-center text-center';
                const isDone = state === 'done';
                const isActive = state === 'active';
                const dotCls = isDone ? 'bg-green-500 border-green-500' : isActive ? 'bg-[#3FD8D4] border-[#3FD8D4]' : 'bg-gray-200 border-gray-300';
                const ringCls = isActive ? 'ring-4 ring-[#3FD8D4]/30' : '';
                const title = i === 0 ? 'KPR Approval Assignment' : i === 1 ? 'Property Appraisal' : i === 2 ? 'Credit Analysis' : 'Final Approval';
                const wf = i > 0 ? sortedWorkflows[i - 1] : undefined;
                return (
                  <div key={i} className={`${base} px-2`}>
                    <div className={`w-6 h-6 rounded-full border ${dotCls} ${ringCls}`} />
                    <div className="mt-3 text-sm font-semibold text-gray-900">{title}</div>
                    <div className="mt-2 w-full max-w-[260px] rounded-xl border p-3 shadow-sm bg-white">
                      {i === 0 ? (
                        <div className="space-y-2 text-xs text-gray-700">
                          <div className="flex justify-between"><span className="text-muted-foreground">PIC</span><span className="font-medium">Super Admin</span></div>
                          <div className="border-t pt-2">
                            <div className="font-medium mb-1">Name Assign</div>
                            {sortedWorkflows.slice(0,3).map((w, idx) => (
                              <div key={w.workflowId} className="flex justify-between">
                                <span className="text-muted-foreground">Step {idx+1}</span>
                                <span className="font-medium truncate max-w-[60%] text-right">{nameOrEmail(w)}</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      ) : (
                        <div className="space-y-2 text-xs text-gray-700">
                          <div className="flex justify-between"><span className="text-muted-foreground">PIC</span><span className="font-medium truncate max-w-[60%] text-right">{nameOrEmail(wf)}</span></div>
                          <div className="flex justify-between"><span className="text-muted-foreground">Email</span><span className="font-medium truncate max-w-[60%] text-right">{wf?.assignedToEmail ?? '-'}</span></div>
                          <div className="flex justify-between"><span className="text-muted-foreground">Status</span>
                            <span className={`px-2 py-0.5 rounded-full border text-[10px] font-semibold ${statusBadge(wf?.status)}`}>{(wf?.status ?? 'PENDING')}</span>
                          </div>
                          <div className="flex justify-between"><span className="text-muted-foreground">Note</span><span className="font-medium truncate max-w-[60%] text-right">{wf?.approvalNotes ?? wf?.rejectionReason ?? '-'}</span></div>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

        </section>

        {/* Detail Customer */}
        <section className="border rounded-2xl p-5 bg-white shadow-sm" style={{ borderColor: colors.gray + '33' }}>
          <h2 className="font-semibold text-black text-lg mb-4 flex items-center gap-2">
            <User2 className="h-6 w-6 text-[#3FD8D4]" /> Detail Customer
          </h2>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* KIRI */}
            <div className="border rounded-xl p-4 bg-card shadow-sm">
              <h3 className="font-semibold text-base mb-3 text-gray-900">Data Profil</h3>
              <div className="space-y-2 text-sm">
                {[
                  ['Nama Lengkap', customer.name],
                  ['Username', customer.username ?? '-'],
                  ['Email', customer.email],
                  ['Telepon', customer.phone ?? '-'],
                  ['NIK', customer.nik ?? '-'],
                  ['NPWP', customer.npwp ?? '-'],
                  ['Tempat/Tgl Lahir', `${customer.birth_place ?? '-'}, ${customer.birth_date ?? '-'}`],
                  ['Jenis Kelamin', customer.gender ?? '-'],
                  ['Status', customer.marital_status ?? '-'],
                  ['Alamat',
                    `${customer.address ?? '-'}, ${customer.sub_district ?? '-'}, ${customer.district ?? '-'}, ${customer.city ?? '-'}`
                  ],
                  ['Provinsi', customer.province ?? '-'],
                  ['Kode Pos', customer.postal_code ?? '-'],
                ].map(([label, value]) => (
                  <div key={label as string} className="flex justify-between border-b pb-1">
                    <span className="text-muted-foreground">{label}</span>
                    <span className="font-medium text-right max-w-[55%]">{value as string}</span>
                  </div>
                ))}

              </div>
            </div>

            {/* KANAN */}
            <div className="border rounded-xl p-4 bg-card shadow-sm">
              <h3 className="font-semibold text-base mb-3 text-gray-900">Data Pekerjaan</h3>
              <div className="space-y-2 text-sm">
                {[
                  ['Pekerjaan', customer.occupation ?? '-'],
                  ['Pendapatan Bulanan', customer.monthly_income ? `Rp ${customer.monthly_income}` : '-'],
                  ['Nama Perusahaan', customer.company_name ?? '-'],
                  ['Alamat Perusahaan',
                    `${customer.company_address ?? '-'}, ${customer.company_subdistrict ?? '-'}, ${customer.company_district ?? '-'}`
                  ],
                  ['Kota', customer.company_city ?? '-'],
                  ['Provinsi', customer.company_province ?? '-'],
                  ['Kode Pos', customer.company_postal_code ?? '-'],
                ].map(([label, value]) => (
                  <div key={label as string} className="flex justify-between border-b pb-1">
                    <span className="text-muted-foreground">{label}</span>
                    <span className="font-medium text-right max-w-[55%]">{value as string}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </section>

        {/* Data Pengajuan KPR & Data Properti */}
        <section className="border rounded-2xl p-5 bg-white shadow-sm" style={{ borderColor: colors.gray + '33' }}>
          <h2 className="font-semibold text-black text-lg mb-4 flex items-center gap-2">
            <FileText className="h-6 w-6 text-[#3FD8D4]" /> Data Pengajuan KPR
          </h2>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {/* Kiri: Data Pengajuan KPR */}
            <div className="border rounded-xl p-4 bg-card shadow-sm">
              <h3 className="font-semibold text-base mb-3 text-gray-900">Data Pengajuan</h3>
              <div className="space-y-2 text-sm">
                {[
                  ['Jenis Properti', (application as any)?.propertyType ?? '-'],
                  ['Nilai Properti', formatIDR((application as any)?.propertyValue)],
                  ['Alamat Properti', (application as any)?.propertyAddress ?? '-'],
                  ['Jenis Sertifikat', (application as any)?.propertyCertificateType ?? '-'],
                  ['Developer', (application as any)?.developerName ?? '-'],
                  ['Plafon (Loan Amount)', formatIDR((application as any)?.loanAmount)],
                  ['Tenor', (() => {
                    const lt = Number((application as any)?.loanTermYears);
                    if (!lt || Number.isNaN(lt)) return '-';
                    return `${lt} bulan`;
                  })()],
                  ['Suku Bunga', (application as any)?.interestRate != null ? `${((application as any)?.interestRate as number) * 100}%` : '-'],
                  ['DP (Down Payment)', formatIDR((application as any)?.downPayment)],
                  ['Rasio LTV', formatPct((application as any)?.ltvRatio)],
                  ['Tujuan', (application as any)?.purpose ?? '-'],
                  ['Diajukan', formatDate((application as any)?.submittedAt)],
                  ['Catatan', (application as any)?.notes ?? '-'],
                ].map(([label, value]) => (
                  <div key={label as string} className="flex justify-between border-b pb-1">
                    <span className="text-muted-foreground">{label}</span>
                    <span className="font-medium text-right max-w-[55%]">{value as string}</span>
                  </div>
                ))}
              </div>
            </div>

            {/* Kanan: Data Properti */}
            <div className="border rounded-xl p-4 bg-card shadow-sm">
              <h3 className="font-semibold text-base mb-3 text-gray-900">Data Properti</h3>
              {(() => {
                const p = (application as any)?.propertyInfo;
                if (!p) {
                  return <p className="text-sm text-muted-foreground">Informasi properti tidak tersedia.</p>;
                }
                return (
                  <div className="space-y-2 text-sm">
                    {[
                      ['Kode Properti', p.propertyCode ?? '-'],
                      ['Judul', p.title ?? '-'],
                      ['Deskripsi', p.description ?? '-'],
                      ['Alamat', p.address ?? '-'],
                      ['Kota', p.city ?? '-'],
                      ['Provinsi', p.province ?? '-'],
                      ['Kode Pos', p.postalCode ?? '-'],
                      ['Kecamatan', p.district ?? '-'],
                      ['Kelurahan', p.village ?? '-'],
                      ['Luas Tanah', p.landArea != null ? `${p.landArea} m²` : '-'],
                      ['Luas Bangunan', p.buildingArea != null ? `${p.buildingArea} m²` : '-'],
                      ['Kamar Tidur', p.bedrooms ?? '-'],
                      ['Kamar Mandi', p.bathrooms ?? '-'],
                      ['Lantai', p.floors ?? '-'],
                      ['Garasi', p.garage ?? '-'],
                      ['Tahun Dibangun', p.yearBuilt ?? '-'],
                      ['Harga', formatIDR(p.price)],
                      ['Harga/m²', formatIDR(p.pricePerSqm)],
                      ['Jenis Sertifikat', p.certificateType ?? '-'],
                      ['Nomor Sertifikat', p.certificateNumber ?? '-'],
                      ['PBB', formatIDR(p.pbbValue)],
                    ].map(([label, value]) => (
                      <div key={label as string} className="flex justify-between border-b pb-1">
                        <span className="text-muted-foreground">{label}</span>
                        <span className="font-medium text-right max-w-[55%]">{value as string}</span>
                      </div>
                    ))}
                  </div>
                );
              })()}
            </div>
          </div>
        </section>

        {/* Dokumen Pendukung */}
        <section className="border rounded-2xl p-5 bg-white shadow-sm" style={{ borderColor: colors.gray + '33' }}>
          <h2 className="font-semibold text-black text-lg mb-4 flex items-center gap-2">
            <FileText className="h-6 w-6 text-[#3FD8D4]" /> Dokumen Pendukung
          </h2>

          <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <DocRow title="Kartu Tanda Penduduk (KTP)" url={customer.ktp || null} onOpen={openDoc} colors={colors} />
            <DocRow title="Slip Gaji" url={customer.slip || null} onOpen={openDoc} colors={colors} />
          </div>
        </section>

        {/* Approve Modal */}
        <Dialog open={showApproveModal} onOpenChange={(v) => setShowApproveModal(v)}>
          <DialogContent className="max-w-md">
            <DialogHeader>
              <DialogTitle>Alasan Persetujuan Kredit</DialogTitle>
            </DialogHeader>
            <div className="mb-3 grid grid-cols-1 gap-2 rounded-xl border p-3 bg-gray-50">
              <SummaryRow label="KPR ID" value={`${(application as any)?.applicationNumber ?? id}`} />
              <SummaryRow label="KPR Price" value={formatIDR((application as any)?.loanAmount ?? loanAmount)} />
              <SummaryRow label="Tenor" value={`${(application as any)?.loanTermYears ?? jangkaWaktu} tahun`} />
              <SummaryRow label="KPR Rate" value={`${(application as any)?.kprRateInfo?.rateName ?? '-'}`} />
              <SummaryRow label="Property" value={`${(application as any)?.propertyInfo?.title ?? '-'}`} />
            </div>
            <div className="py-2">
              <textarea
                className="w-full border rounded p-2 min-h-[60px]"
                placeholder="Masukkan alasan persetujuan..."
                value={reasonInput}
                onChange={e => setReasonInput(e.target.value)}
              />
            </div>
            <div className="flex justify-end pt-2">
              <Button
                disabled={actionLoading || !reasonInput.trim()}
                onClick={async () => {
                  setActionLoading(true);
                  try {
                    const result = await approveKPRApplication(id, reasonInput.trim());
                    setShowApproveModal(false);
                    setApprovalDialog({ open: true, data: {
                      application_id: id,
                      customer_name: customer?.name ?? "",
                      property_name: "-",
                      address: customer?.address ?? "",
                      price: loanAmount,
                      status: "Approved",
                      approval_date: new Date().toISOString(),
                      reason: reasonInput.trim(),
                      apiResult: result,
                    }});
                  } catch (err: any) {
                    setShowApproveModal(false);
                    setApprovalDialog({ open: true, data: {
                      application_id: id,
                      customer_name: customer?.name ?? "",
                      property_name: "-",
                      address: customer?.address ?? "",
                      price: loanAmount,
                      status: "Error",
                      approval_date: new Date().toISOString(),
                      error: err?.message || "Gagal menyetujui pengajuan.",
                      reason: reasonInput.trim(),
                    }});
                  } finally {
                    setActionLoading(false);
                  }
                }}
              >{actionLoading ? "Memproses..." : "Approve"}</Button>
            </div>
          </DialogContent>
        </Dialog>

        {/* Reject Modal */}
        <Dialog open={showRejectModal} onOpenChange={(v) => setShowRejectModal(v)}>
          <DialogContent className="max-w-md">
            <DialogHeader>
              <DialogTitle>Alasan Penolakan Kredit</DialogTitle>
            </DialogHeader>
            <div className="mb-3 grid grid-cols-1 gap-2 rounded-xl border p-3 bg-gray-50">
              <SummaryRow label="KPR ID" value={`${(application as any)?.applicationNumber ?? id}`} />
              <SummaryRow label="KPR Price" value={formatIDR((application as any)?.loanAmount ?? loanAmount)} />
              <SummaryRow label="Tenor" value={`${(application as any)?.loanTermYears ?? jangkaWaktu} tahun`} />
              <SummaryRow label="KPR Rate" value={`${(application as any)?.kprRateInfo?.rateName ?? '-'}`} />
              <SummaryRow label="Property" value={`${(application as any)?.propertyInfo?.title ?? '-'}`} />
            </div>
            <div className="py-2">
              <textarea
                className="w-full border rounded p-2 min-h-[60px]"
                placeholder="Masukkan alasan penolakan..."
                value={reasonInput}
                onChange={e => setReasonInput(e.target.value)}
              />
            </div>
            <div className="flex justify-end pt-2">
              <Button
                disabled={actionLoading || !reasonInput.trim()}
                onClick={async () => {
                  setActionLoading(true);
                  try {
                    const result = await rejectKPRApplication(id, reasonInput.trim());
                    setShowRejectModal(false);
                    setRejectDialog({ open: true, summary: result?.message || "Pengajuan kredit telah ditolak." });
                  } catch (err: any) {
                    setShowRejectModal(false);
                    setRejectDialog({ open: true, summary: err?.message || "Gagal menolak pengajuan." });
                  } finally {
                    setActionLoading(false);
                  }
                }}
              >{actionLoading ? "Memproses..." : "Reject"}</Button>
            </div>
          </DialogContent>
        </Dialog>
      </main>

      {/* Document viewer */}
      <ViewDocumentDialog open={docViewer.open} onOpenChange={(v) => (v ? null : closeDoc())} title={docViewer.title} imageUrl={docViewer.url} />

      {/* Approval details dialog */}
      {approvalDialog.open && (
        <ViewApprovalDetails
          open={approvalDialog.open}
          onOpenChange={(v) => {
            setApprovalDialog({ open: false, data: null });
            if (v === false) router.push("/dashboard");
          }}
          data={approvalDialog.data}
        />
      )}

      {/* Rejection summary dialog */}
      {rejectDialog.open && (
        <Dialog open={rejectDialog.open} onOpenChange={(v) => {
          setRejectDialog({ open: false, summary: null });
          if (v === false) router.push("/dashboard");
        }}>
          <DialogContent className="max-w-md">
            <DialogHeader>
              <DialogTitle>Pengajuan Kredit Ditolak</DialogTitle>
            </DialogHeader>
            <div className="py-4 text-sm text-muted-foreground">{rejectDialog.summary}</div>
            <div className="flex justify-end pt-2">
              <Button onClick={() => {
                setRejectDialog({ open: false, summary: null });
                router.push("/dashboard");
              }}>Kembali ke Dashboard</Button>
            </div>
          </DialogContent>
        </Dialog>
      )}
    </div>
  );
}

/* ---------- Reusable SummaryCard ---------- */
function SummaryCard({
  colors,
  icon,
  title,
  children,
}: {
  colors: { blue: string; gray: string; orange: string };
  icon: React.ReactNode;
  title: string;
  children: React.ReactNode;
}) {
  return (
    <div
      className="p-5 rounded-2xl shadow-sm border h-full flex flex-col items-center text-center"
      style={{ borderColor: colors.gray + '33' }}
    >
      {/* Header: icon + title perfectly centered */}
      <div className="flex items-center justify-center gap-2 h-8">
        {/* make icon not affect baseline */}
        <div className="[&_svg]:block shrink-0 flex items-center justify-center">
          {icon}
        </div>
        <span className="text-sm font-semibold text-gray-700 leading-none align-middle mb-0">
          {title}
        </span>
      </div>

      <div className="mt-3 w-full flex-1 flex flex-col items-center justify-center">
        {children}
      </div>
    </div>
  );
}

/* ---------- Helpers ---------- */

// Removed unused escapeHtml and toHtmlWithBold functions

function mapToCustomerDetail(id: string, d: KPRApplicationData): CustomerDetail {
  const ui = d.userInfo ?? {};

  const ktpDoc  = d.documents?.find(x => /KTP|IDENTITY/i.test(x.documentType ?? ''));
  const slipDoc = d.documents?.find(x => /SLIP|GAJI|INCOME/i.test(x.documentType ?? ''));

  return {
    id: String((ui as any).userId ?? d.id ?? d.applicationId ?? id),
    name: d.applicantName ?? d.fullName ?? ui.fullName ?? 'Tidak Diketahui',
    username: d.username ?? (ui as any).username ?? '-',
    email: d.applicantEmail ?? d.email ?? (ui as any).email ?? 'unknown@example.com',
    phone: d.applicantPhone ?? d.phone ?? (ui as any).phone ?? '-',
    nik: d.nik ?? (ui as any).nik ?? '-',
    npwp: d.npwp ?? (ui as any).npwp ?? '-',
    birth_place: d.birthPlace ?? (ui as any).birthPlace ?? '-',
    birth_date: (d as any).birthDate ?? (ui as any).birthDate ?? '-',
    gender: d.gender ?? (ui as any).gender ?? '-',
    marital_status: (d as any).marital_status ?? (ui as any).maritalStatus ?? '-',
    address: d.address ?? (ui as any).address ?? '-',
    sub_district: (d as any).sub_district ?? '-',
    district: (d as any).district ?? '-',
    city: d.city ?? (ui as any).city ?? '-',
    province: d.province ?? (ui as any).province ?? '-',
    postal_code: (d as any).postal_code ?? (ui as any).postalCode ?? '-',

    occupation: d.occupation ?? (ui as any).occupation ?? '-',
    monthly_income: d.monthly_income ?? d.income ?? (ui as any).monthlyIncome ?? '-',
    company_name: d.company_name ?? (ui as any).companyName ?? '-',
    company_address: (d as any).company_address ?? (ui as any).companyAddress ?? '-',
    company_subdistrict: (d as any).company_subdistrict ?? '-',
    company_district: (d as any).company_district ?? '-',
    company_city: (d as any).company_city ?? '-',
    company_province: (d as any).company_province ?? '-',
    company_postal_code: (d as any).company_postal_code ?? '-',

    credit_status: (d as any).credit_status ?? 'Lancar',
    credit_score: (d as any).credit_score ?? '01',

    ktp: ktpDoc?.filePath ?? null,
    slip: slipDoc?.filePath ?? null,
  };
}

// Removed unused helper functions for cleaner bundling

function DocRow({ title, url, onOpen, colors }: { title: string; url: string | null; onOpen: (t: string, u: string | null) => void; colors: any }) {
  return (
    <div className="border rounded-xl p-5 shadow-sm bg-gray-50 flex items-center justify-between">
      <p className="font-semibold text-gray-800 text-base">{title}</p>
      <Button
        onClick={() => onOpen(title, url)}
        variant="outline"
        className="text-[#0B63E5] border-[#0B63E5]/60 hover:bg-[#0B63E5]/10 font-semibold shadow-sm"
      >
        <Eye className="mr-2 h-4 w-4" /> Lihat
      </Button>
    </div>
  );
}

// Removed unused InstallmentTable and buildMultiSegmentSchedule functions for cleaner bundling

function SummaryRow({ label, value }: { label: string; value: string }) {}
*/